nonzeroCoef <- function (beta, bystep = FALSE) {
  ### bystep = FALSE means which variables were ever nonzero
  ### bystep = TRUE means which variables are nonzero for each step
  nr <- nrow(beta)
  if (nr == 1) {#degenerate case
    if (bystep)
      apply(beta, 2, function(x) if (abs(x) > 0)
        1
        else NULL)
    else {
      if (any(abs(beta) > 0))
        1
      else NULL
    }
  }
  else {
    beta <- abs(beta)>0 # this is sparse
    which <- seq(nr)
    ones <- rep(1,ncol(beta))
    nz <- as.vector((beta%*%ones)>0)
    which <- which[nz]
    if (bystep) {
      if(length(which)>0){
        beta <- as.matrix(beta[which,,drop=FALSE])
        nzel <- function(x, which) if (any(x))
          which[x]
        else NULL
        which <- apply(beta, 2, nzel, which)
        if(!is.list(which))which=data.frame(which)# apply can return a matrix!!
        which
      }
      else{
        dn <- dimnames(beta)[[2]]
        which <- vector("list",length(dn))
        names(which) <- dn
        which
      }

    }
    else which
  }
}
